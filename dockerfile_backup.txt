FROM docker.io/library/python:3.12-slim

WORKDIR /app

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    TZ=Asia/Shanghai \
    APP_HOST=0.0.0.0 \
    DEBIAN_FRONTEND=noninteractive

# 安装系统依赖和 TeX Live
RUN echo "=== 安装系统依赖和 TeX Live ===" && \
    apt-get update && apt-get install -y --no-install-recommends \
    # 基础编译工具
    build-essential p7zip-full libmariadb-dev-compat \
    # R 语言环境
    r-base r-base-dev r-cran-readxl r-cran-dplyr \
    r-cran-jsonlite r-cran-tidyverse r-cran-readr \
    # TeX Live 相关
    texlive-xetex texlive-lang-chinese texlive-plain-generic \
    texlive-fonts-recommended \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# 检查关键宏包是否正确安装
RUN echo "=== 检查关键宏包安装状态 ===" && \
    for pkg in ctex tabularx fontspec ulem makecell adjustbox amssymb pifont array calc ifthen hyperref geometry; do \
        echo -n "检查 $pkg... " && \
        FOUND=$(find /usr/share/texlive -name "$pkg.sty" -type f 2>/dev/null | head -1) && \
        if [ -n "$FOUND" ]; then \
            echo "✓ 找到"; \
        else \
            echo "✗ 未找到"; \
        fi; \
    done

# 最终验证 XeLaTeX 功能
RUN echo "=== 最终验证 XeLaTeX 功能 ===" && \
    xelatex --version && echo "✓ XeLaTeX 最终可用"

# 安装 Python 依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 安装 R 包
RUN Rscript -e 'install.packages(c("RMySQL","feather"), repos="http://cran.rstudio.com/")'

# 复制应用代码
COPY . .

# 创建必要目录
RUN mkdir -p /app/temp /app/logs /app/rpa_reports

EXPOSE 8000
CMD ["python", "run.py"]
